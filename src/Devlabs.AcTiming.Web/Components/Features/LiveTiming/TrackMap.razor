@using Devlabs.AcTiming.Domain.LiveTiming
@using Devlabs.AcTiming.Web.Services
@namespace Devlabs.AcTiming.Web.Components.Features.LiveTiming
@inject TrackMapService MapService
@inject IJSRuntime JS
@implements IAsyncDisposable

@if (_config is null)
{
    <div class="track-map-unavailable">Map not available for this track.</div>
}
else
{
    <div class="track-map" @ref="_mapRef">
        @if (_config.HasImage)
        {
            <div class="track-map-img-wrap">
                <img src="maps/@_config.FullTrackName/map.png" alt="Track Map" />
            </div>
        }
        <svg viewBox="0 0 @_config.PixelWidth @_config.PixelHeight"
             preserveAspectRatio="xMidYMid meet">
            @{
                var nonSelected = Drivers.Where(d => d.CarId != SelectedCarId).ToList();
                var selectedDriver = SelectedCarId is not null ? Drivers.FirstOrDefault(d => d.CarId == SelectedCarId) : null;
                var renderOrder = selectedDriver is not null
                    ? nonSelected.Concat([selectedDriver]).ToList()
                    : nonSelected;
            }
            @for (var i = 0; i < renderOrder.Count; i++)
            {
                var driver = renderOrder[i];
                var pos = Drivers.ToList().IndexOf(driver) + 1;
                var px = (driver.WorldX + _config.XOffset) / _config.ScaleFactor;
                var py = (driver.WorldZ + _config.ZOffset) / _config.ScaleFactor;
                var color = GetDriverColor(driver.CarId);
                var pxStr = px.ToString("F1");
                var pyStr = py.ToString("F1");
                var isSelected = driver.CarId == SelectedCarId;
                var pinClass = isSelected ? "driver-pin selected" : "driver-pin";

                <g class="@pinClass" transform="translate(@pxStr, @pyStr)" style="--pin-color: @color">
                    <title>@driver.DriverName â€” @driver.SpeedKmh.ToString("F0") km/h</title>
                    @if (isSelected)
                    {
                        <circle class="pin-glow" cx="0" cy="0" />
                    }
                    <circle class="pin-circle" cx="0" cy="0" fill="@color" />
                    <text class="pin-pos" x="0" y="0" text-anchor="middle" dominant-baseline="central">@pos</text>
                    <text class="pin-name" x="0" y="0">@driver.DriverName</text>
                </g>
            }
        </svg>
    </div>
}

@code {
    [Parameter] public IReadOnlyList<LiveDriverEntry> Drivers { get; set; } = [];
    [Parameter] public string? TrackName { get; set; }
    [Parameter] public string? TrackConfig { get; set; }
    [Parameter] public int? SelectedCarId { get; set; }

    private TrackMapConfig? _config;
    private ElementReference _mapRef;
    private IJSObjectReference? _mapJs;

    protected override void OnParametersSet()
    {
        _config = MapService.GetConfig(TrackName, TrackConfig);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _config is not null)
        {
            _mapJs = await JS.InvokeAsync<IJSObjectReference>("import", "/js/trackMap.js");
            await _mapJs.InvokeVoidAsync("init", _mapRef);
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_mapJs is not null)
        {
            await _mapJs.InvokeVoidAsync("dispose", _mapRef);
            await _mapJs.DisposeAsync();
        }
    }

    private static readonly string[] Colors =
    [
        "#e94560", "#4ecca3", "#3498db", "#f39c12",
        "#9b59b6", "#1abc9c", "#e67e22", "#2ecc71",
        "#e74c3c", "#00cec9", "#fd79a8", "#6c5ce7"
    ];

    private static string GetDriverColor(int carId) => Colors[carId % Colors.Length];
}
