@page "/"
@using Devlabs.AcTiming.Application.Cars
@using Devlabs.AcTiming.Domain.LiveTiming
@using Devlabs.AcTiming.Web.Hubs
@using Microsoft.AspNetCore.SignalR.Client
@implements IAsyncDisposable
@inject ICarBrandResolver CarBrandResolver

<PageTitle>Live Timing - AC Timing</PageTitle>

<div class="timing-page">

    <!-- ── Session bar ───────────────────────────────────────────────────── -->
    <div class="session-bar">
        <div class="session-bar-left">
            @if (_session is not null)
            {
                <span class="session-type-badge">@_session.SessionType</span>
                <span class="session-track">
                    @_session.TrackName@(string.IsNullOrEmpty(_session.TrackConfig) ? "" : $" · {_session.TrackConfig}")
                </span>
                <span class="session-separator">│</span>
                <span class="session-server">@_session.ServerName</span>
                <span class="session-separator">│</span>
                <span class="session-temps">Road @_session.RoadTemp°C</span>
            }
            else
            {
                <span class="session-waiting">Waiting for session…</span>
            }
        </div>
        <div class="session-bar-right">
            @{
                var timer = FormatSessionTimer();
                if (!string.IsNullOrEmpty(timer))
                {
                    <span class="session-timer">@timer</span>
                }
            }
            <span class="connection-dot @(_hubConnection?.State == HubConnectionState.Connected ? "connected" : "disconnected")">
                ●&nbsp;@(_hubConnection?.State == HubConnectionState.Connected ? "Connected" : "Disconnected")
            </span>
        </div>
    </div>

    <!-- ── Two-column grid ───────────────────────────────────────────────── -->
    <div class="timing-grid">

        <!-- Left column: map + events -->
        <div class="left-col">

            <div class="panel map-panel">
                <div class="panel-header">Map</div>
                <div class="map-body">
                    @if (_leaderboard.Count > 0)
                    {
                        <TrackMap Drivers="_leaderboard" />
                    }
                    else
                    {
                        <span class="panel-empty">No drivers on track</span>
                    }
                </div>
            </div>

            <div class="panel events-panel">
                <div class="panel-header">Events</div>
                <div class="events-list">
                    @if (_events.Count == 0)
                    {
                        <span class="panel-empty">No events yet</span>
                    }
                    @foreach (var evt in _events)
                    {
                        <div class="event-item">
                            <div class="event-indicator event-@evt.Kind.ToString().ToLower()"></div>
                            <div class="event-content">
                                <span class="event-time">@evt.Timestamp.ToLocalTime().ToString("HH:mm:ss")</span>
                                <span class="event-message">@evt.Message</span>
                            </div>
                        </div>
                    }
                </div>
            </div>

        </div>

        <!-- Right column: leaderboard + selected driver -->
        <div class="right-col">

            @{
                var sorted = _leaderboard
                    .OrderBy(d => d.BestLapTimeMs is null or 0 ? 1 : 0)
                    .ThenBy(d => d.BestLapTimeMs ?? int.MaxValue)
                    .ToList();
                var fastestLap = sorted.FirstOrDefault()?.BestLapTimeMs;
                var overallBest = sorted
                    .Where(d => d.BestLapTimeMs is not null and not 0)
                    .Min(d => (int?)d.BestLapTimeMs);
            }
            <div class="panel leaderboard-panel">
                <div class="leaderboard-scroll">
                    @if (_leaderboard.Count == 0)
                    {
                        <span class="panel-empty">No drivers on track</span>
                    }
                    else
                    {
                        <table class="timing-table">
                            <thead>
                                <tr>
                                    <th>Pos</th>
                                    <th>Driver</th>
                                    <th>Car</th>
                                    <th>Best Lap</th>
                                    <th title="Most recent completed lap. Red = invalid (corner cut).">Last Lap</th>
                                    <th title="Delta to personal best">Δ</th>
                                    <th>Laps</th>
                                    <th>
                                        <div class="gap-toggle" title="@(_showInterval ? "Gap to car ahead" : "Gap to leader")">
                                            <button class="gap-toggle-btn @(!_showInterval ? "active" : "")" @onclick="() => _showInterval = false">Gap</button>
                                            <button class="gap-toggle-btn @(_showInterval ? "active" : "")" @onclick="() => _showInterval = true">Int</button>
                                        </div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (var i = 0; i < sorted.Count; i++)
                                {
                                    var driver = sorted[i];
                                    var prevDriver = i > 0 ? sorted[i - 1] : null;
                                    var isSelected = driver.CarId == _selectedCarId;
                                    <tr class="driver-row @(isSelected ? "selected" : "") @(driver.IsConnected ? "" : "disconnected")"
                                        @onclick="() => SelectDriver(driver.CarId)">
                                        <td class="pos">@(i + 1)</td>
                                        <td class="driver-name">
                                            <span class="driver-dot" style="background-color: @GetDriverColor(driver.CarId)"></span>@driver.DriverName
                                        </td>
                                        <td class="car-name">
                                            <CarBrandIcon Model="@driver.CarModel" Resolver="CarBrandResolver" ShowLabel/>
                                        </td>
                                        <td class="laptime">@FormatLapTime(driver.BestLapTimeMs)</td>
                                        <td class="laptime @GetLastLapColorClass(driver, overallBest) @(driver.LastLapCuts > 0 ? "lap-invalid" : "")">
                                            @FormatLapTime(driver.LastLapTimeMs)
                                            @if (driver.LastLapCuts > 0)
                                            {
                                                <span class="cuts-badge" title="@driver.LastLapCuts corner cut(s) — lap invalid">@driver.LastLapCuts</span>
                                            }
                                        </td>
                                        <td class="laptime @GetDeltaColorClass(driver)">@FormatDelta(driver)</td>
                                        <td>@driver.TotalLaps</td>
                                        <td class="gap">
                                            @if (_showInterval)
                                            {
                                                @FormatInterval(driver.BestLapTimeMs, prevDriver?.BestLapTimeMs)
                                            }
                                            else
                                            {
                                                @FormatGap(driver.BestLapTimeMs, fastestLap)
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                </div>
            </div>

            <!-- Selected driver panel — only visible when a row is selected -->
            @if (_selectedCarId is not null)
            {
                var sel = SelectedDriver;
                if (sel is not null)
                {
                    <div class="panel driver-panel">

                        <!-- Driver identity -->
                        <div class="driver-panel-header">
                            <div class="driver-panel-identity">
                                <span class="driver-dot large-dot" style="background-color: @GetDriverColor(sel.CarId)"></span>
                                <div>
                                    <div class="driver-panel-name">@sel.DriverName</div>
                                    <div class="driver-panel-car">
                                        <CarBrandIcon Model="@sel.CarModel" Resolver="CarBrandResolver" ShowLabel="true" />
                                    </div>
                                </div>
                            </div>
                            <button class="close-btn" @onclick="ClearSelection" title="Close">✕</button>
                        </div>

                        <!-- Live Telemetry -->
                        <div class="dp-section dp-section-telemetry">
                            <div class="dp-section-header">Live Telemetry</div>
                            <div class="dp-telem-row">
                                <div class="dp-telem-cell">
                                    <div class="dp-telem-main">
                                        <span class="dp-telem-value">@(sel.SpeedKmh > 1 ? $"{sel.SpeedKmh:F0}" : "—")</span>
                                        @if (sel.SpeedKmh > 1) { <span class="dp-telem-unit">km/h</span> }
                                    </div>
                                    <div class="dp-telem-label">Speed</div>
                                </div>
                                <div class="dp-telem-cell">
                                    <div class="dp-telem-main">
                                        <span class="dp-telem-value">@FormatGear(sel.Gear)</span>
                                    </div>
                                    <div class="dp-telem-label">Gear</div>
                                </div>
                                <div class="dp-telem-cell dp-telem-rpm">
                                    <div class="rpm-bar">
                                        <div class="rpm-fill" style="width: @(Math.Min(100, sel.EngineRpm / 100.0).ToString("F0"))%"></div>
                                    </div>
                                    <div class="dp-telem-main">
                                        <span class="dp-telem-value">@(sel.EngineRpm > 0 ? sel.EngineRpm.ToString("N0") : "—")</span>
                                    </div>
                                    <div class="dp-telem-label">RPM</div>
                                </div>
                            </div>
                        </div>

                        <!-- Historical -->
                        <div class="dp-section dp-section-history">
                            <div class="dp-section-header">Historical</div>
                            <div class="dp-stat-row">
                                <span class="dp-stat-label">Best this session</span>
                                <span class="dp-stat-value">@FormatLapTime(sel.BestLapTimeMs)</span>
                            </div>
                            <div class="dp-stat-row">
                                <span class="dp-stat-label">Best all-time (car)</span>
                                <span class="dp-stat-value placeholder">—</span>
                            </div>
                            <div class="dp-stat-row">
                                <span class="dp-stat-label">Total laps</span>
                                <span class="dp-stat-value">@sel.TotalLaps</span>
                            </div>
                            <div class="dp-stat-row last">
                                <span class="dp-stat-label">Incidents</span>
                                <span class="dp-stat-value">@(_incidents.Count(i => i.CarId == sel.CarId))</span>
                            </div>
                        </div>

                    </div>
                }
            }

        </div>
    </div>
</div>

@code {
    // ── SignalR & session state ────────────────────────────────────────────
    private HubConnection? _hubConnection;
    private LiveSessionInfo? _session;
    private List<LiveDriverEntry> _leaderboard = [];
    private DateTime? _sessionStartedAt;
    private PeriodicTimer? _tickTimer;
    private CancellationTokenSource? _tickCts;
    private bool _showInterval;

    // ── Driver selection ──────────────────────────────────────────────────
    private int? _selectedCarId;
    private LiveDriverEntry? SelectedDriver =>
        _selectedCarId is null ? null : _leaderboard.FirstOrDefault(d => d.CarId == _selectedCarId);

    private void SelectDriver(int carId) =>
        _selectedCarId = _selectedCarId == carId ? null : carId;

    private void ClearSelection() => _selectedCarId = null;

    // ── Events log ────────────────────────────────────────────────────────
    private enum EventKind { SessionStart, SessionEnd, Join, Disconnect, Collision }
    private record TimingEvent(EventKind Kind, string Message, DateTime Timestamp);
    private readonly List<TimingEvent> _events = [];

    private void AddEvent(EventKind kind, string message)
    {
        _events.Insert(0, new TimingEvent(kind, message, DateTime.UtcNow));
        if (_events.Count > 10)
            _events.RemoveAt(_events.Count - 1);
    }

    // ── Collision tracking (for incident count in driver panel) ───────────
    private readonly List<CollisionEvent> _incidents = [];

    // ── Initialization ────────────────────────────────────────────────────
    protected override async Task OnInitializedAsync()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri(TimingHub.HubUrl))
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<LiveSessionInfo?>(TimingHubMethods.SessionUpdated, session =>
        {
            InvokeAsync(() =>
            {
                _session = session;
                if (session is not null)
                {
                    _sessionStartedAt = DateTime.UtcNow - TimeSpan.FromMilliseconds(session.ElapsedMs);
                    AddEvent(EventKind.SessionStart, $"Session started — {session.TrackName}");
                }
                else
                {
                    _sessionStartedAt = null;
                    AddEvent(EventKind.SessionEnd, "Session ended");
                }
                StateHasChanged();
            });
        });

        _hubConnection.On<List<LiveDriverEntry>>(TimingHubMethods.LeaderboardUpdated, leaderboard =>
        {
            InvokeAsync(() =>
            {
                _leaderboard = leaderboard;
                StateHasChanged();
            });
        });

        _hubConnection.On<LiveDriverEntry>(TimingHubMethods.DriverUpdated, driver =>
        {
            InvokeAsync(() =>
            {
                var idx = _leaderboard.FindIndex(d => d.CarId == driver.CarId);
                if (idx >= 0)
                    _leaderboard[idx] = driver;
                else
                {
                    _leaderboard.Add(driver);
                    AddEvent(EventKind.Join, $"{driver.DriverName} joined");
                }
                StateHasChanged();
            });
        });

        _hubConnection.On<int>(TimingHubMethods.DriverDisconnected, carId =>
        {
            InvokeAsync(() =>
            {
                var name = _leaderboard.FirstOrDefault(d => d.CarId == carId)?.DriverName ?? $"Car #{carId}";
                _leaderboard.RemoveAll(d => d.CarId == carId);
                if (_selectedCarId == carId) _selectedCarId = null;
                AddEvent(EventKind.Disconnect, $"{name} disconnected");
                StateHasChanged();
            });
        });

        _hubConnection.On<CollisionEvent>(TimingHubMethods.CollisionOccurred, evt =>
        {
            InvokeAsync(() =>
            {
                _incidents.Insert(0, evt);
                if (_incidents.Count > 50)
                    _incidents.RemoveAt(_incidents.Count - 1);
                AddEvent(EventKind.Collision, FormatIncident(evt));
                StateHasChanged();
            });
        });

        await _hubConnection.StartAsync();
        await _hubConnection.InvokeAsync("RequestFullState");

        StartTickTimer();
    }

    private void StartTickTimer()
    {
        _tickCts = new CancellationTokenSource();
        _tickTimer = new PeriodicTimer(TimeSpan.FromSeconds(1));
        _ = TickLoopAsync(_tickCts.Token);
    }

    private async Task TickLoopAsync(CancellationToken ct)
    {
        while (await _tickTimer!.WaitForNextTickAsync(ct))
        {
            if (_session is not null && _sessionStartedAt is not null)
                await InvokeAsync(StateHasChanged);
        }
    }

    [Inject] private NavigationManager NavigationManager { get; set; } = default!;

    // ── Formatting helpers ─────────────────────────────────────────────────
    private string FormatIncident(CollisionEvent evt)
    {
        var driver = GetDriverName(evt.CarId);
        return evt.Type switch
        {
            CollisionType.Car => $"{driver} ↔ {GetDriverName(evt.OtherCarId!.Value)} — {evt.ImpactSpeedKmh:F0} km/h",
            _ => $"{driver} environment crash — {evt.ImpactSpeedKmh:F0} km/h"
        };
    }

    private string GetDriverName(int carId) =>
        _leaderboard.FirstOrDefault(d => d.CarId == carId)?.DriverName ?? $"Car #{carId}";

    private static readonly string[] DriverColors =
    [
        "#e94560", "#4ecca3", "#3498db", "#f39c12",
        "#9b59b6", "#1abc9c", "#e67e22", "#2ecc71",
        "#e74c3c", "#00cec9", "#fd79a8", "#6c5ce7"
    ];

    private static string GetDriverColor(int carId) => DriverColors[carId % DriverColors.Length];

    private static string FormatLapTime(int? ms)
    {
        if (ms is null or 0) return "—";
        var ts = TimeSpan.FromMilliseconds(ms.Value);
        return ts.Minutes > 0
            ? $"{ts.Minutes}:{ts.Seconds:D2}.{ts.Milliseconds:D3}"
            : $"{ts.Seconds}.{ts.Milliseconds:D3}";
    }

    private static string FormatGap(int? driverMs, int? leaderMs)
    {
        if (driverMs is null or 0 || leaderMs is null or 0) return "—";
        var gap = driverMs.Value - leaderMs.Value;
        if (gap == 0) return FormatLapTime(driverMs);
        return FormatSignedGap(gap);
    }

    private static string FormatInterval(int? driverMs, int? aheadMs)
    {
        if (aheadMs is null) return FormatLapTime(driverMs);
        if (driverMs is null or 0 || aheadMs is 0) return "—";
        var gap = driverMs.Value - aheadMs.Value;
        if (gap == 0) return FormatLapTime(driverMs);
        return FormatSignedGap(gap);
    }

    private static string FormatDelta(LiveDriverEntry driver)
    {
        if (driver.LastLapTimeMs is null or 0 || driver.BestLapTimeMs is null or 0) return "—";
        var delta = driver.LastLapTimeMs.Value - driver.BestLapTimeMs.Value;
        if (delta == 0) return "PB";
        return FormatSignedGap(delta);
    }

    private static string FormatSignedGap(int ms)
    {
        var sign = ms >= 0 ? "+" : "-";
        var abs = Math.Abs(ms) / 1000.0;
        return $"{sign}{abs:F3}";
    }

    private static string FormatGear(int gear) => gear switch
    {
        0 => "R",
        1 => "N",
        _ => (gear - 1).ToString()
    };

    private static string GetLastLapColorClass(LiveDriverEntry driver, int? overallBest)
    {
        if (driver.LastLapTimeMs is null or 0) return "";
        if (driver.LastLapCuts > 0) return "";
        if (overallBest is not null && driver.LastLapTimeMs == overallBest) return "lap-purple";
        if (driver.BestLapTimeMs is not null && driver.LastLapTimeMs == driver.BestLapTimeMs) return "lap-green";
        return "lap-yellow";
    }

    private static string GetDeltaColorClass(LiveDriverEntry driver)
    {
        if (driver.LastLapTimeMs is null or 0 || driver.BestLapTimeMs is null or 0) return "";
        var delta = driver.LastLapTimeMs.Value - driver.BestLapTimeMs.Value;
        return delta == 0 ? "delta-pb" : "delta-positive";
    }

    private string FormatSessionTimer()
    {
        if (_session is null || _sessionStartedAt is null) return "";

        if (_session.TimeLimitMinutes > 0)
        {
            var totalSeconds = _session.TimeLimitMinutes * 60;
            var elapsed = (DateTime.UtcNow - _sessionStartedAt.Value).TotalSeconds;
            var remaining = Math.Max(0, totalSeconds - elapsed);
            var ts = TimeSpan.FromSeconds(remaining);
            return $"{(int)ts.TotalMinutes}:{ts.Seconds:D2}";
        }

        if (_session.LapLimit > 0)
        {
            var maxLaps = _leaderboard.Count > 0 ? _leaderboard.Max(d => d.TotalLaps) : 0;
            return $"Lap {maxLaps} / {_session.LapLimit}";
        }

        return "";
    }

    public async ValueTask DisposeAsync()
    {
        _tickCts?.Cancel();
        _tickTimer?.Dispose();
        _tickCts?.Dispose();
        if (_hubConnection is not null)
            await _hubConnection.DisposeAsync();
    }
}
